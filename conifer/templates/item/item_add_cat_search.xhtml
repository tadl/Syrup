<?python
from django.utils.simplejson import dumps
from conifer.libsystems.z3950.marcxml import marcxml_dictionary_to_dc as to_dublin
title = _('Add physical item: Catalogue search')
dc_keys = ['dc:title', 'dc:creator', 'dc:publisher', 'dc:date']
?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:py="http://genshi.edgewall.org/">
<xi:include href="../master.xhtml"/>
<xi:include href="../paginate.xhtml"/>
<xi:include href="../components/course.xhtml"/>
<head>
  <title>${title}</title>
  <script type="text/javascript">
    <!-- !This ought to be in paginate.xhtml, not here. how to do? -->
    $(function() { $('.pagetable').tablesorter(); });
  </script>
  <script py:if="request.method != 'POST'">		       <!-- !focus on query box if nothing to scroll. -->
    $(function() { $('#query').focus(); });
  </script>
</head>
<body>
    ${course_banner(course)}
    ${nested_title(parent_item)}
    <h2>${title}</h2>
    <form method="POST" action=".">
      <input type="text" id="query" name="query" value="${query}" 
	     style="font-size: larger; width: 600;"/>
      <input type="submit" value="Search"/>
    </form>

    <table class="pagetable" py:if="request.method == 'POST'">
      <thead>
	<tr><th>Title</th><th>Author</th><th>Publisher</th><th>PubDate</th></tr>
      </thead>
      <tbody py:for="resultnum, res in enumerate(results)"
	     py:with="dc=to_dublin(res)">
	<tr>
	  <td>
	    ${dc.get('dc:title', '???')}
	    <a href="javascript:$('#full_${resultnum}').toggle(); void(0);">details</a>
	  </td>
	  <td py:for="k in dc_keys[1:]">${dc.get(k) or '&mdash;'}</td>
	  <td>
	    <form action="." method="POST">
	      <input type="hidden" name="pickitem" value="${dumps(res)}"/>
	      <input type="submit" value="Pick this item"/>
	    </form>
	  </td>
	</tr>
	<tr id="full_${resultnum}" style="display: none;">
	  <td colspan="4" style="padding-left: 36;">
	    <table class="metadata_table">
	      <?python allkeys = res.keys(); allkeys.sort(); ?>
	      <tr py:for="k in allkeys">
		<th>${k}</th><td>${res[k]}</td>
	      </tr>
	    </table>
	  </td>
	</tr>
      </tbody>
    </table>
 </body>
</html>
